<script type="text/javascript" src="./../js/selector.js"></script>
<script>
function goToPage(url, delay) {
	setTimeout("window.location=\"" + url + "\"", delay);
}

function confirmDelete() {
	return confirm("Are you sure you want to delete this request?");
}
</script>
    <div class="content">
<?php 
        if (isset($_POST["date"]) && isset($_POST["player"]) && isset($_POST["sub"])) {
            // need to check to see if the date has been taken
            $success = ScheduleDAO::assignSubByDate($_POST["date"], $_POST["player"], $_POST["sub"]);
            if ($success) {
                $player = PlayerDAO::getPlayer($_POST["player"]);
                $substitute = PlayerDAO::getPlayer($_POST["sub"]);
                $playerEmailAddress = $player->emailAddress;
                // get the email addresses for the administrators
                $adminEmails = PlayerDAO::getAdminEmails();
                $toAddresses = implode(", ", $subEmails);
                $toAddresses .= ", $playerEmailAddress";

                $subject = getConfigValue("General", "siteTitle") . " Substitute Taken";
?>
                <fieldset class="editPlayerFields">
                    <h1>You have the spot!</h1>
                </fieldset>
                <script>
                    dojoConfig = {parseOnLoad: true}
                </script>
                <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js"></script>
                <script>
                    require(["dojo/request"], function(request) { 
                        var message = "<?= $substitute->firstName ?> <?= $substitute->lastName ?> took the sub spot requested by <?= $player->firstName ?> <?= $player->lastName ?> for <?= $_POST["date"] ?>.";
                        request.post("/service/EmailService.php", { 
                            data: { 
                                to: '<?= $toAddresses ?>', 
                                subject: '<?= $subject ?>', 
                                message: message
                            }
                        });

                        console.log("Sent an email to \"<?= $toAddresses ?>\" with the subject \"<?= $subject ?>\" and message \"" + message + "\"");
                    });
                    goToPage("subs.php", 2000);
                </script>
<?php
            } else {
?>
                <fieldset class="editPlayerFields">
                    <h1>Spot already taken</h1>
                    <p>Click <a href="subs.php">here</a> to check other spots that may be available</p>
                </fieldset>
<?php
            }
        } else if (isset($_GET["date"]) && isset($_GET["player"])) {
            $subs = PlayerDAO::getSubs();
            $playersThatAlreadyHaveASpot = ScheduleDAO::getTakenDateSubsByDate($_GET["date"]);
?>
            <form name="subForm" id="subForm" method="POST" action="subs.php">
                <fieldset class="editPlayerFields">
                    <p>
                        <label for="sub" class="playerTitle">Your Name:</label>
                        <span class="textbox">
                            <select name="sub" id="sub">
                                <option value="-1">-- Please Select Your Name --</option>
<?php 
                                foreach ($subs as $sub) {
                                    if (!in_array($sub->id, $playersThatAlreadyHaveASpot)) {
?>
                                        <option value="<?=$sub->id?>"><?=$sub->lastName?>, <?=$sub->firstName?></option>
<?php
                                    }
                                }
?>
                            </select>
                            <span id="subError" class="error">Please select your name from the list</span>
                            <input type="hidden" name="date" id="date" value="<?=$_GET["date"]?>"/>
                            <input type="hidden" name="player" id="player" value="<?=$_GET["player"]?>"/>
                        </span>
                    </p>
				    <div id="alignRight">
				    	<label for="submit">
				    	    <input name="submitRequestButton" type="button" onclick="validateAndSubmit()" value="Submit Request"/>
				    	</label>
				    </div>
                </fieldset>
            </form>
            <script>
                dojoConfig = {parseOnLoad: true}
            </script>
            <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js"></script>
            <script>
                function validateAndSubmit() {
                    // make sure that a player was actually selected
                    var playerId = dojo.byId("sub");
                    if (playerId.value == "-1") {
                        dojo.byId("subError").style.display = "inline";
                    } else {
                        dojo.byId("subForm").submit();
                    }
                }
            </script>
<?php
        } else {
?>
            <fieldset class="editPlayerFields">
                <p>
                    <a href="requestSubstitute.php">Request a Sub</a>
                </p>
<?php
            $subsList = ScheduleDAO::getFutureAvailableDateSubs();
            if (count($subsList) > 0) {
?>
                <p>
                    <span class="title">The following are requested sub spots that have not been taken</span>
                </p>
                <ul>
<?php 
                    foreach ($subsList as $subEntry) {
                        $entryPlayerId = $subEntry["player"];
                        $entryDate = $subEntry["date"];
                        $entryPlayer = PlayerDAO::getPlayer($entryPlayerId);
                        $partner = TeamDAO::getParterOfPlayer($entryPlayerId, $entryDate);
?>
                        <li>
                            <a href="subs.php?date=<?=$entryDate?>&player=<?=$entryPlayerId?>"><?=$entryDate?> - <?=$entryPlayer->firstName?> <?=$entryPlayer->lastName?></a>
<?php
                            if (null != $partner) {
                                // check to see if the partner has a sub...
                                $partnerSub = ScheduleDAO::getSubstituteByDate($entryDate, $partner->id);
                                if ($partnerSub != null && $partnerSub != "X") {
                                    // get the sub info
                                    $partner = PlayerDAO::getPlayer($partnerSub);
                                }
?>
                                (partnered with <?=$partner->firstName?> <?=$partner->lastName?>)
<?php

                            }
                            if ($_SESSION["admin"] == 1) {
?>
                                - <a onclick="return confirmDelete()" href="/admin/delete-subrequest.php?date=<?=$entryDate?>&player=<?=$entryPlayerId?>">Delete</a>
<?php
                            }
?>
                        </li>
<?php
                    }
?>
                </ul>
                <hr/>
<?php
            } else {
?>
                <p>There are no current requests for subs</p>
                <hr/>
<?php
            }
            $takenList = ScheduleDAO::getFutureTakenDateSubs();
            if (count($takenList) > 0) {
?>
                <p>
                    <span class="title">These are the taken sub spots</span>
                </p>
                <ul>
<?php 
                    foreach ($takenList as $subEntry) {
                        $entryPlayerId = $subEntry["player"];
                        $entryDate = $subEntry["date"];
                        $entrySubId = $subEntry["sub"];
                        $entryPlayer = PlayerDAO::getPlayer($entryPlayerId);
                        $entrySub = PlayerDAO::getPlayer($entrySubId);
                        $partner = TeamDAO::getParterOfPlayer($entryPlayerId, $entryDate);
?>
                        <li>
                            <?=$entryDate?> - <?=$entrySub->firstName?> <?=$entrySub->lastName?> will be playing for <?=$entryPlayer->firstName?> <?=$entryPlayer->lastName?>
<?php
                            if (null != $partner) {
                                // check to see if the partner has a sub...
                                $partnerSub = ScheduleDAO::getSubstituteByDate($entryDate, $partner->id);
                                if ($partnerSub != null && $partnerSub != "X") {
                                    // get the sub info
                                    $partner = PlayerDAO::getPlayer($partnerSub);
                                }
?>
                                (partnered with <?=$partner->firstName?> <?=$partner->lastName?>)
<?php
                            }
                            if ($_SESSION["admin"] == 1) {
?>
                                - <a onclick="return confirmDelete()" href="/admin/delete-subrequest.php?date=<?=$entryDate?>&player=<?=$entryPlayerId?>">Delete</a>
<?php
                            }
?>
                        </li>
<?php
                    }
?>
                </ul>
<?php
            }
?>
            </fieldset>
<?php
        }
?>
    </div>